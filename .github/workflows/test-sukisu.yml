name: WSA Kernel v5.15 GKI x86_64 SukiSU

on:
  workflow_dispatch:
    inputs:
      kernel_tag:
        description: 'WSA kernel tag'
        required: true
        default: 'android-lts/latte-2/5.15.104.4'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 拉取源码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 安装基础依赖
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            bc bison build-essential flex git \
            libelf-dev libssl-dev libncurses-dev \
            ca-certificates gnupg lsb-release \
            software-properties-common wget \
            python3 python-is-python3 \
            rsync unzip zip

      # 3. 安装 LLVM
      - name: Install LLVM toolchain
        run: |
          sudo apt install -y clang llvm lld

          clang --version
          ld.lld --version

      # 4. 切换到指定 WSA kernel tag
      - name: Checkout WSA kernel tag
        run: |
          git fetch --tags
          git checkout ${{ github.event.inputs.kernel_tag }}

      # 5. 集成 SukiSU-Ultra
      - name: Setup SukiSU-Ultra (Kprobe)
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" \
            | bash -s main

      # 6. 启用 GKI + KernelSU / kprobe
      - name: Enable GKI + KSU configs
        run: |
          # 指定 GKI x86_64 构建入口
          export BUILD_CONFIG=build.config.gki.x86_64

          # 确保 scripts/config 可用
          chmod +x scripts/config

      # 7. 构建 GKI 内核（官方方式）
      - name: Build GKI kernel (x86_64)
        run: |
          export BUILD_CONFIG=build.config.gki.x86_64
          build/build.sh

      # 8. 上传构建产物
      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: WSA-GKI-v5.15-x86_64-SukiSU
          path: |
            out/**/dist/bzImage
