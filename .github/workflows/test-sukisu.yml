name: WSA Kernel v5.15 GKI x86_64 SukiSU

on:
  workflow_dispatch:
    inputs:
      kernel_tag:
        description: 'WSA kernel tag'
        required: true
        default: 'android-lts/latte-2/5.15.104.4'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 拉取微软官方内核源码
      # 直接指定 repository 为 microsoft/WSA-Linux-Kernel
      # 直接指定 ref 为输入的 tag
      - name: Checkout WSA Kernel Source
        uses: actions/checkout@v4
        with:
          repository: microsoft/WSA-Linux-Kernel
          ref: ${{ inputs.kernel_tag }}
          fetch-depth: 1

      # 2. 安装基础依赖
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            bc bison build-essential flex git \
            libelf-dev libssl-dev libncurses-dev \
            ca-certificates gnupg lsb-release \
            software-properties-common wget \
            rsync

      # 3. 安装 LLVM 12 
      - name: Setup LLVM toolchain
        run: |
          sudo apt install -y clang-12 lld-12 llvm-12
          
          # 建立软链接
          sudo ln -sf /usr/bin/clang-12 /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-12 /usr/bin/clang++
          sudo ln -sf /usr/bin/ld.lld-12 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-ar-12 /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-12 /usr/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-strip-12 /usr/bin/llvm-strip
          sudo ln -sf /usr/bin/llvm-objcopy-12 /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-objdump-12 /usr/bin/llvm-objdump
          
          clang --version


      # 4. 集成 SukiSU-Ultra (Kprobe 模式)
      - name: Setup SukiSU-Ultra (Kprobe)
        run: |
          # 下载并执行 SukiSU 安装脚本
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" \
            | bash -s main

      # 5. 配置内核
      - name: Configure kernel
        run: |
          # 复制 WSA 官方 x86_64 配置文件
          cp configs/wsa/config-wsa-x64 .config
          
          # 手动开启 KernelSU 和 Kprobe 相关选项
          echo "CONFIG_KPROBES=y" >> .config
          echo "CONFIG_HAVE_KPROBES=y" >> .config
          echo "CONFIG_KPROBE_EVENTS=y" >> .config
          echo CONFIG_KSU_MANUAL_HOOK=y >> .config
          
          # 刷新配置
          make olddefconfig

      # 6. 编译内核
      - name: Build WSA kernel
        run: |
          make -j$(nproc) LLVM=1 bzImage

      # 7. 上传构建产物
      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: WSA-GKI-v5.15-x86_64-SukiSU
          path: arch/x86/boot/bzImage
