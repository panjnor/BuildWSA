name: WSA Kernel v5.15 GKI x86_64 SukiSU

on:
  workflow_dispatch:
    inputs:
      kernel_tag:
        description: 'WSA kernel tag'
        required: true
        default: 'android-lts/latte-2/5.15.104.4'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 拉取源码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 安装基础依赖
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            bc bison build-essential flex git \
            libelf-dev libssl-dev libncurses-dev \
            ca-certificates gnupg lsb-release \
            software-properties-common wget \
            rsync

      # 3. 安装 LLVM 12 
      - name: Setup LLVM toolchain
        run: |
          # Ubuntu 22.04 自带 clang-12，直接安装
          sudo apt update
          sudo apt install -y clang-12 lld-12 llvm-12

          # 创建软链接，确保 make 调用的是 v12 版本
          # 注意：Ubuntu 默认安装后，二进制文件带 -12 后缀
          sudo ln -sf /usr/bin/clang-12 /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-12 /usr/bin/clang++
          sudo ln -sf /usr/bin/ld.lld-12 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-ar-12 /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-12 /usr/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-strip-12 /usr/bin/llvm-strip
          sudo ln -sf /usr/bin/llvm-objcopy-12 /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-objdump-12 /usr/bin/llvm-objdump
          
          # 验证版本
          clang --version

      # 4. 切换到指定 WSA kernel tag
      - name: Checkout WSA kernel tag
        run: |
          git fetch --tags
          git checkout ${{ github.event.inputs.kernel_tag }}

      # 5. 集成 SukiSU-Ultra (Kprobe 模式)
      # 这会将 SukiSU 源码下载到 drivers/kernelsu 并修改 Kconfig/Makefile
      - name: Setup SukiSU-Ultra (Kprobe)
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" \
            | bash -s main

      # 6. 配置内核 (关键步骤：混合 WSA 配置与 KSU 配置)
      - name: Configure kernel
        run: |
          # A. 复制 WSA 官方推荐的 x86_64 配置文件
          cp configs/wsa/config-wsa-x64 .config
          
          # B. 手动注入 KSU 和 Kprobe 配置 (这就相当于修改了 GKI 配置)
          echo "CONFIG_KPROBES=y" >> .config
          echo "CONFIG_HAVE_KPROBES=y" >> .config
          echo "CONFIG_KPROBE_EVENTS=y" >> .config
          echo CONFIG_KSU_MANUAL_HOOK=y >> .config
          
          # C. 验证并更新配置
          make olddefconfig

      # 7. 编译内核
      # 使用 LLVM=1 启用 Clang 编译，-j$(nproc) 并行编译
      - name: Build WSA kernel
        run: |
          make -j$(nproc) LLVM=1 bzImage

      # 8. 上传构建产物
      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: WSA-GKI-v5.15-x86_64-SukiSU
          path: arch/x86/boot/bzImage
